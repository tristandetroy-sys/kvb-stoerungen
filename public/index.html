<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>KVB St√∂rungen</title>

  <!-- üîÅ Auto-Refresh alle 10 Minuten -->
  <meta http-equiv="refresh" content="600">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      color: #000;
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 720px;
      padding: 20px;
      box-sizing: border-box;
    }

    h1 {
      text-align: center;
      font-size: 28px;
      margin-bottom: 22px;
    }

    .card {
      border: 2px solid #000;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .emoji {
      font-size: 42px;
      line-height: 1;
    }

    .content h2 {
      margin: 0 0 6px 0;
      font-size: 22px;
    }

    .content p {
      margin: 0;
      font-size: 16px;
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .ok {
      border: 3px solid #000;
      border-radius: 20px;
      padding: 40px 20px;
      text-align: center;
    }

    .ok .emoji {
      font-size: 64px;
      margin-bottom: 10px;
    }

    .updated {
      text-align: center;
      font-size: 14px;
      margin-top: 18px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üöã KVB Betriebslage</h1>
    <div id="output">Lade Daten ‚Ä¶</div>
    <div class="updated" id="updated"></div>
  </div>

  <script>
    const LINES = ["1", "3", "4", "5", "7", "12", "15"];
    const output = document.getElementById("output");

    fetch("/api/stoerungen")
      .then(res => res.arrayBuffer())
      .then(buffer => {
        // üî• WICHTIG: korrektes Encoding erzwingen
        const decoder = new TextDecoder("iso-8859-1");
        const html = decoder.decode(buffer);

        const doc = new DOMParser().parseFromString(html, "text/html");
        const items = doc.querySelectorAll("#stoer_bahn li.list-group-item");

        let results = [];

        items.forEach(item => {
          const num = item.querySelector("h3.liniennummer");
          if (!num) return;

          const line = num.textContent.trim();
          if (!LINES.includes(line)) return;

          const textBox = item.querySelector(".col-xs-9");
          const text = textBox
            ? textBox.textContent.replace(/\s+/g, " ").trim()
            : "";

          results.push({ line, text });
        });

        output.innerHTML = "";

        if (results.length === 0) {
          output.innerHTML = `
            <div class="ok">
              <div class="emoji">‚úÖ</div>
              <h2>Keine St√∂rungen</h2>
              <p>Linien 1 ¬∑ 3 ¬∑ 4 ¬∑ 5 ¬∑ 7 ¬∑ 12 ¬∑ 15</p>
            </div>
          `;
        } else {
          results.forEach(r => {
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
              <div class="emoji">üöß</div>
              <div class="content">
                <h2>Linie ${r.line}</h2>
                <p>${r.text}</p>
              </div>
            `;
            output.appendChild(div);
          });
        }

        document.getElementById("updated").textContent =
          "Letzte Aktualisierung: " + new Date().toLocaleTimeString("de-DE");
      })
      .catch(err => {
        output.innerHTML = "‚ö†Ô∏è Fehler beim Laden der KVB-Daten";
        console.error(err);
      });
  </script>
</body>
</html>
